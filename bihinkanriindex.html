<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物品貸出管理アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #qr-reader {
            border: 2px dashed #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
        /* QRコード表示領域のスタイリング */
        #qrcode-display {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
            min-height: 288px; /* 256px + padding */
        }
        #qrcode-display canvas {
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <!-- ヘッダー -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">物品貸出管理アプリ</h1>
            <p class="text-gray-600 mt-2">社内の備品や機材の貸し出し状況を管理します。</p>
        </header>

        <main class="space-y-8">
            <!-- アクションエリア -->
            <section class="bg-white p-4 rounded-lg shadow-md fade-in flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="relative w-full md:w-2/3">
                    <input type="search" id="search-box" placeholder="物品ID、物品名、カテゴリ、または貸出先で検索..." class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="w-full md:w-1/3 flex flex-col md:flex-row gap-2">
                     <button id="scan-qr-btn" class="w-full inline-flex items-center justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        QRスキャン
                    </button>
                    <button id="open-add-item-modal-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                        物品を追加
                    </button>
                </div>
            </section>

            <!-- 物品一覧 -->
            <section id="item-list-section" class="bg-white p-6 rounded-lg shadow-md fade-in">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">物品一覧</h2>

                <!-- タブUI -->
                <div class="mb-4 border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tab-available" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600">
                            貸出可能
                        </button>
                        <button id="tab-lending" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            貸出中
                        </button>
                    </nav>
                </div>

                <!-- タブコンテンツ -->
                <div id="tab-content-available" class="tab-content space-y-4">
                    <!-- 貸出可能アイテム -->
                    <p id="no-available-items" class="text-gray-500 hidden">該当する物品はありません。</p>
                </div>
                <div id="tab-content-lending" class="tab-content space-y-4 hidden">
                    <!-- 貸出中アイテム -->
                    <p id="no-lending-items" class="text-gray-500 hidden">該当する物品はありません。</p>
                </div>

            </section>
        </main>

        <!-- フッター -->
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>&copy; 2024 物品貸出管理アプリ. All Rights Reserved.</p>
        </footer>
    </div>

    <!-- 物品追加モーダル -->
    <div id="add-item-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-2xl font-semibold">物品を新規追加</h2>
                    <button id="close-add-item-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <form id="add-item-form" class="space-y-4">
                    <div>
                        <label for="new-item-name" class="block text-sm font-medium text-gray-700">物品名</label>
                        <input type="text" id="new-item-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="例：プロジェクターA">
                    </div>
                     <div>
                        <label for="new-item-quantity" class="block text-sm font-medium text-gray-700">数量</label>
                        <input type="number" id="new-item-quantity" required value="1" min="1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <p class="text-xs text-gray-500 mt-1">個別に管理したい物品は、数量1で一つずつ登録してください。</p>
                    </div>
                    <div>
                        <label for="new-item-category" class="block text-sm font-medium text-gray-700">カテゴリ</label>
                        <div class="relative">
                            <input type="text" id="new-item-category" required placeholder="物品名を入力するとAIが自動入力します..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <div id="category-loader" class="absolute right-3 top-1/2 -translate-y-1/2 hidden">
                                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-indigo-500"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">AIによる自動分類候補です。自由に編集できます。</p>
                    </div>
                    <div class="text-right pt-2">
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                            追加する
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 貸出モーダル -->
    <div id="lending-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-2xl font-semibold">貸出手続き</h2>
                    <button id="close-lending-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <form id="lending-form" class="space-y-4">
                    <input type="hidden" id="lending-item-id">
                    <div>
                        <p class="text-sm font-medium text-gray-700">対象物品</p>
                        <p id="lending-item-name" class="mt-1 text-lg font-semibold text-gray-900"></p>
                    </div>
                    <div>
                        <label for="lending-quantity" class="block text-sm font-medium text-gray-700">数量</label>
                         <input type="number" id="lending-quantity" name="lending-quantity" required value="1" min="1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="borrower-name" class="block text-sm font-medium text-gray-700">貸出先（氏名）</label>
                        <input type="text" id="borrower-name" name="borrower-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="例：山田 太郎">
                    </div>
                    <div>
                        <label for="due-date" class="block text-sm font-medium text-gray-700">返却予定日</label>
                        <input type="date" id="due-date" name="due-date" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div class="text-right pt-2">
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                            貸し出す
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 返却モーダル -->
    <div id="return-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-2xl font-semibold">返却手続き</h2>
                    <button id="close-return-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <form id="return-form" class="space-y-4">
                    <input type="hidden" id="return-record-id">
                    <div>
                        <p class="text-sm font-medium text-gray-700">対象物品</p>
                        <p id="return-item-name" class="mt-1 text-lg font-semibold text-gray-900"></p>
                         <p id="return-borrower-info" class="text-sm text-gray-600"></p>
                    </div>
                    <div>
                        <label for="return-quantity" class="block text-sm font-medium text-gray-700">返却する数量</label>
                         <input type="number" id="return-quantity" name="return-quantity" required value="1" min="1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div class="text-right pt-2">
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                            返却する
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <h2 class="text-2xl font-semibold my-4">本当に削除しますか？</h2>
                <p id="delete-confirm-message" class="mb-6 text-gray-700"></p>
                <div class="flex justify-center gap-4">
                     <button id="cancel-delete-btn" class="py-2 px-6 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">キャンセル</button>
                    <button id="confirm-delete-btn" class="py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700">はい、削除します</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QRコード表示モーダル (新規追加) -->
    <div id="qr-code-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-xs">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 id="qr-code-modal-title" class="text-xl font-semibold">物品QRコード</h2>
                    <button id="close-qr-code-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div id="qrcode-display" class="w-full h-auto">
                    <!-- QRコードはここにJSで生成されます -->
                </div>
                <p class="text-center text-sm text-gray-500 mt-4">このコードをスキャンして貸出・返却を行います。</p>
            </div>
        </div>
    </div>

    <!-- QRリーダーモーダル -->
    <div id="qr-reader-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6">
                 <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-2xl font-semibold">QRコードをスキャン</h2>
                    <button id="close-qr-reader-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div id="qr-reader" class="w-full"></div>
                <p class="text-center text-sm text-gray-500 mt-4">物品のQRコードをカメラに向けてください。</p>
            </div>
        </div>
    </div>

    <!-- QRスキャン結果モーダル -->
    <div id="qr-result-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden fade-in">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 id="qr-result-item-name" class="text-2xl font-semibold"></h2>
                    <button id="close-qr-result-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div id="qr-result-content" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- スキャン結果がここに表示される -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- トースト通知 -->
    <div id="toast-notification" class="fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg hidden transition-opacity duration-300 opacity-0">
        <p id="toast-message"></p>
    </div>


    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM要素取得 ---
            const itemListSection = document.getElementById('item-list-section');
            const searchBoxEl = document.getElementById('search-box');

            // タブ関連
            const tabAvailableBtn = document.getElementById('tab-available');
            const tabLendingBtn = document.getElementById('tab-lending');
            const tabContentAvailable = document.getElementById('tab-content-available');
            const tabContentLending = document.getElementById('tab-content-lending');
            const noAvailableItemsEl = document.getElementById('no-available-items');
            const noLendingItemsEl = document.getElementById('no-lending-items');
            
            // モーダル関連
            const addItemModal = document.getElementById('add-item-modal');
            const openAddItemModalBtn = document.getElementById('open-add-item-modal-btn');
            const closeAddItemModalBtn = document.getElementById('close-add-item-modal-btn');
            const addItemForm = document.getElementById('add-item-form');
            
            const lendingModal = document.getElementById('lending-modal');
            const closeLendingModalBtn = document.getElementById('close-lending-modal-btn');
            const lendingForm = document.getElementById('lending-form');

            const returnModal = document.getElementById('return-modal');
            const closeReturnModalBtn = document.getElementById('close-return-modal-btn');
            const returnForm = document.getElementById('return-form');

            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

            const qrCodeModal = document.getElementById('qr-code-modal'); // 新規
            const closeQrCodeModalBtn = document.getElementById('close-qr-code-modal-btn'); // 新規
            const qrCodeModalTitleEl = document.getElementById('qr-code-modal-title'); // 新規
            const qrcodeDisplayEl = document.getElementById('qrcode-display'); // 新規
            let qrCodeInstance = null; // QRコードのインスタンスを保持

            const qrReaderModal = document.getElementById('qr-reader-modal');
            const scanQrBtn = document.getElementById('scan-qr-btn');
            const closeQrReaderBtn = document.getElementById('close-qr-reader-btn');
            const qrResultModal = document.getElementById('qr-result-modal');
            const closeQrResultModalBtn = document.getElementById('close-qr-result-modal-btn');

            const newItemNameInput = document.getElementById('new-item-name');
            const newItemCategoryInput = document.getElementById('new-item-category');
            const categoryLoader = document.getElementById('category-loader');
            
            const dueDateInput = document.getElementById('due-date');
            const today = new Date().toISOString().split('T')[0];
            dueDateInput.setAttribute('min', today);

            let debounceTimer;
            const html5QrCode = new Html5Qrcode("qr-reader");

            // --- データ管理 ---
            let managedItems = [
                { itemId: 'ITEM-001', name: 'ノートPC (Dell XPS)', category: '電子機器', totalQuantity: 1, availableQuantity: 0 },
                { itemId: 'ITEM-002', name: '会議室用マイク', category: '音響機器', totalQuantity: 1, availableQuantity: 0 },
                { itemId: 'ITEM-003', name: 'Webカメラ', category: '電子機器', totalQuantity: 5, availableQuantity: 5 },
                { itemId: 'ITEM-004', name: 'HDMIケーブル', category: 'ケーブル', totalQuantity: 10, availableQuantity: 8 }
            ];
            let rentalRecords = [
                { recordId: 1, itemId: 'ITEM-001', borrower: '鈴木 一郎', rentalDate: '2025-10-06', dueDate: '2025-10-10', quantity: 1, returnDate: null },
                { recordId: 2, itemId: 'ITEM-002', borrower: '佐藤 花子', rentalDate: '2025-10-07', dueDate: '2025-10-08', quantity: 1, returnDate: null },
                { recordId: 3, itemId: 'ITEM-004', borrower: '高橋 健太', rentalDate: '2025-10-08', dueDate: '2025-10-15', quantity: 2, returnDate: null }
            ];
            let nextItemId = 5;
            let nextRecordId = 4;

            function generateItemId() {
                return 'ITEM-' + String(nextItemId++).padStart(3, '0');
            }

            // --- 表示関連 ---
            function renderList() {
                // 古いカードを削除（「該当なし」のpタグは残す）
                tabContentAvailable.querySelectorAll('.border.rounded-lg').forEach(el => el.remove());
                tabContentLending.querySelectorAll('.border.rounded-lg').forEach(el => el.remove());

                const searchTerm = searchBoxEl.value.toLowerCase();
                let hasAvailableItems = false;
                let hasLendingItems = false;
                
                managedItems.forEach(item => {
                    const activeRecords = rentalRecords.filter(r => r.itemId === item.itemId && r.returnDate === null);
                    const isMatch = item.itemId.toLowerCase().includes(searchTerm) ||
                                    item.name.toLowerCase().includes(searchTerm) ||
                                    item.category.toLowerCase().includes(searchTerm) ||
                                    activeRecords.some(r => r.borrower.toLowerCase().includes(searchTerm));

                    if (!isMatch) return;

                    // --- カード生成ロジック (共通) ---
                    let status, statusColor, statusText;
                    if (item.availableQuantity === 0) {
                        status = 'lending'; statusColor = 'red'; statusText = '貸出中';
                    } else if (item.availableQuantity < item.totalQuantity) {
                        status = 'partial'; statusColor = 'blue'; statusText = '一部貸出中';
                    } else {
                        status = 'available'; statusColor = 'gray'; statusText = '貸出可能';
                    }

                    const statusBadge = `<span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-${statusColor}-600 bg-${statusColor}-200">${statusText}</span>`;

                    let loansHtml = '';
                    if (activeRecords.length > 0) {
                        loansHtml = '<div class="mt-3 space-y-2 border-t pt-3">';
                        activeRecords.forEach(record => {
                             const isOverdue = new Date(record.dueDate) < new Date(today);
                             loansHtml += `
                                <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded-md">
                                    <div>
                                        <p><strong>貸出先:</strong> ${escapeHTML(record.borrower)} (${record.quantity}個)</p>
                                        <p class="${isOverdue ? 'text-red-600 font-semibold' : 'text-gray-600'}"><strong>返却予定:</strong> ${record.dueDate} ${isOverdue ? '(期限切れ)' : ''}</p>
                                    </div>
                                    <button data-record-id="${record.recordId}" class="return-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 text-xs rounded-md transition-colors">返却</button>
                                </div>`;
                        });
                        loansHtml += '</div>';
                    }

                    const isLentOut = item.availableQuantity !== item.totalQuantity;

                    const card = `
                        <div class="border rounded-lg p-4 transition-shadow hover:shadow-lg fade-in">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2">
                                <div class="flex-grow">
                                    <div class="flex items-center gap-3 mb-1">
                                        <p class="font-bold text-lg text-indigo-800">${escapeHTML(item.name)}</p>
                                        ${statusBadge}
                                    </div>
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <p class="text-xs text-gray-500 font-mono">${item.itemId}</p>
                                        <span class="text-xs bg-gray-100 text-gray-800 px-2 py-0.5 rounded-full">${escapeHTML(item.category)}</span>
                                        <span class="text-sm font-semibold text-gray-700">在庫: ${item.availableQuantity} / ${item.totalQuantity}</span>
                                    </div>
                                </div>
                                <div class="flex-shrink-0 w-full md:w-auto mt-2 md:mt-0 flex items-center gap-2">
                                    <button data-item-id="${item.itemId}" data-item-name="${escapeHTML(item.name)}" title="QRコードを表示" class="qr-code-btn p-2 text-gray-400 hover:text-indigo-600 hover:bg-indigo-100 rounded-full transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /><path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16v16H4z" /><path stroke-linecap="round" stroke-linejoin="round" d="M10 10h4v4h-4z" /></svg>
                                    </button>
                                    <button data-item-id="${item.itemId}" ${item.availableQuantity === 0 ? 'disabled' : ''} class="lend-btn w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">貸出</button>
                                    <button data-item-id="${item.itemId}" ${isLentOut ? 'disabled' : ''} title="${isLentOut ? '貸出中の物品は削除できません' : '物品を削除'}" class="delete-btn p-2 text-gray-400 hover:text-red-600 hover:bg-red-100 rounded-full transition-colors disabled:cursor-not-allowed disabled:text-gray-300 disabled:hover:bg-transparent">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                            </div>
                            ${loansHtml}
                        </div>`;
                    // --- カード生成ロジックここまで ---

                    // 振り分け
                    if (item.availableQuantity > 0) {
                        hasAvailableItems = true;
                        tabContentAvailable.insertAdjacentHTML('beforeend', card);
                    } else if (item.totalQuantity > 0) { // availableQuantityが0でtotalが0より大きい
                        hasLendingItems = true;
                        tabContentLending.insertAdjacentHTML('beforeend', card);
                    }
                });
                
                noAvailableItemsEl.classList.toggle('hidden', hasAvailableItems);
                noLendingItemsEl.classList.toggle('hidden', hasLendingItems);
            }

            // --- イベントハンドラ ---
            addItemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('new-item-name').value.trim();
                const category = document.getElementById('new-item-category').value.trim();
                const quantity = parseInt(document.getElementById('new-item-quantity').value, 10);

                if (name && category && quantity > 0) {
                    managedItems.unshift({
                        itemId: generateItemId(),
                        name, category,
                        totalQuantity: quantity,
                        availableQuantity: quantity
                    });
                    renderList();
                    addItemForm.reset();
                    document.getElementById('new-item-quantity').value = 1;
                    addItemModal.classList.add('hidden');
                    showToast('新しい物品を追加しました', false);
                } else {
                    showToast('すべての項目を正しく入力してください。');
                }
            });

            lendingForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const itemId = document.getElementById('lending-item-id').value;
                const borrower = document.getElementById('borrower-name').value.trim();
                const dueDate = document.getElementById('due-date').value;
                const quantity = parseInt(document.getElementById('lending-quantity').value, 10);
                const item = managedItems.find(i => i.itemId === itemId);

                if (borrower && dueDate && quantity > 0 && quantity <= item.availableQuantity) {
                    item.availableQuantity -= quantity;
                    rentalRecords.push({
                        recordId: nextRecordId++,
                        itemId, borrower, dueDate, quantity,
                        rentalDate: today,
                        returnDate: null
                    });
                    renderList();
                    lendingForm.reset();
                    lendingModal.classList.add('hidden');
                    showToast(`${item.name}を${quantity}個貸し出しました。`, false);
                } else {
                    showToast('入力内容が正しくありません。数量が在庫を超えていないか確認してください。');
                }
            });

            returnForm.addEventListener('submit', e => {
                e.preventDefault();
                const recordId = parseInt(document.getElementById('return-record-id').value, 10);
                const quantity = parseInt(document.getElementById('return-quantity').value, 10);
                const record = rentalRecords.find(r => r.recordId === recordId);
                const item = managedItems.find(i => i.itemId === record.itemId);

                if (quantity > 0 && quantity <= record.quantity) {
                    item.availableQuantity += quantity;
                    record.quantity -= quantity;
                    if (record.quantity === 0) {
                        record.returnDate = today;
                    }
                    renderList();
                    returnModal.classList.add('hidden');
                    showToast(`${item.name}を${quantity}個返却しました。`, false);
                } else {
                    showToast('返却数量が貸出数を超えています。');
                }
            });
            
            confirmDeleteBtn.addEventListener('click', () => {
                const itemId = confirmDeleteBtn.dataset.itemId;
                handleDelete(itemId);
                deleteConfirmModal.classList.add('hidden');
            });

            // イベントデリゲーションをitemListSection（タブコンテンツの親）に設定
            itemListSection.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return; // ボタン以外へのクリックは無視
                
                // ボタンの種類を判定
                if (target.classList.contains('lend-btn')) {
                    openLendingModal(target.dataset.itemId);
                } else if (target.classList.contains('return-btn')) {
                    openReturnModal(target.dataset.recordId);
                } else if (target.classList.contains('delete-btn')) {
                    openDeleteConfirmModal(target.dataset.itemId);
                } else if (target.classList.contains('qr-code-btn')) { // 新規
                    openQrCodeModal(target.dataset.itemId, target.dataset.itemName);
                }
            });

            // --- 削除処理 ---
            function handleDelete(itemId) {
                const item = managedItems.find(i => i.itemId === itemId);
                if (!item) return;

                // 貸出中でないことを再確認
                if (item.availableQuantity !== item.totalQuantity) {
                    showToast('貸出中の物品は削除できません。');
                    return;
                }
                
                // 物品をマスターから削除
                managedItems = managedItems.filter(i => i.itemId !== itemId);
                // 関連する貸出記録をすべて削除
                rentalRecords = rentalRecords.filter(r => r.itemId !== itemId);
                
                renderList();
                showToast(`${item.name} を削除しました。`, false);
            }

            // --- QRコード関連 ---
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                stopQrScanner();
                const item = managedItems.find(i => i.itemId === decodedText);
                if (!item) {
                    showToast('該当する物品が見つかりませんでした。');
                    return;
                }
                openQrResultModal(item.itemId);
            };

            scanQrBtn.addEventListener('click', () => {
                qrReaderModal.classList.remove('hidden');
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, qrCodeSuccessCallback)
                    .catch(err => console.log(`QRコードのスキャンを開始できませんでした: ${err}`));
            });
            
            function stopQrScanner() {
                 html5QrCode.stop().then(ignore => {}).catch(err => {});
                 qrReaderModal.classList.add('hidden');
            }

            // --- タブ切り替え ---
            tabAvailableBtn.addEventListener('click', () => {
                tabAvailableBtn.classList.add('border-indigo-500', 'text-indigo-600');
                tabAvailableBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                
                tabLendingBtn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                tabLendingBtn.classList.remove('border-indigo-500', 'text-indigo-600');
                
                tabContentAvailable.classList.remove('hidden');
                tabContentLending.classList.add('hidden');
            });

            tabLendingBtn.addEventListener('click', () => {
                tabLendingBtn.classList.add('border-indigo-500', 'text-indigo-600');
                tabLendingBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                
                tabAvailableBtn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                tabAvailableBtn.classList.remove('border-indigo-500', 'text-indigo-600');
                
                tabContentLending.classList.remove('hidden');
                tabContentAvailable.classList.add('hidden');
            });

            // --- モーダル制御 ---
            function openLendingModal(itemId) {
                const item = managedItems.find(i => i.itemId === itemId);
                document.getElementById('lending-item-id').value = item.itemId;
                document.getElementById('lending-item-name').textContent = `${item.name} (${item.itemId})`;
                const quantityInput = document.getElementById('lending-quantity');
                quantityInput.value = 1;
                quantityInput.max = item.availableQuantity;
                lendingModal.classList.remove('hidden');
            }

            function openReturnModal(recordId) {
                const record = rentalRecords.find(r => r.recordId == recordId);
                const item = managedItems.find(i => i.itemId === record.itemId);
                document.getElementById('return-record-id').value = record.recordId;
                document.getElementById('return-item-name').textContent = `${item.name} (${item.itemId})`;
                document.getElementById('return-borrower-info').textContent = `貸出先: ${record.borrower} (${record.quantity}個貸出中)`;
                const quantityInput = document.getElementById('return-quantity');
                quantityInput.value = 1;
                quantityInput.max = record.quantity;
                returnModal.classList.remove('hidden');
            }
            
            function openDeleteConfirmModal(itemId) {
                const item = managedItems.find(i => i.itemId === itemId);
                const messageEl = document.getElementById('delete-confirm-message');
                messageEl.textContent = `「${escapeHTML(item.name)}」をシステムから完全に削除します。この操作は元に戻せません。`;
                confirmDeleteBtn.dataset.itemId = itemId;
                deleteConfirmModal.classList.remove('hidden');
            }
            
            // 新規: QRコード表示モーダルを開く
            function openQrCodeModal(itemId, itemName) {
                qrCodeModalTitleEl.textContent = itemName;
                qrcodeDisplayEl.innerHTML = ''; // 既存のQRコードをクリア
                
                // qrcode.jsライブラリを使ってQRコードを生成
                try {
                    new QRCode(qrcodeDisplayEl, {
                        text: itemId,
                        width: 256,
                        height: 256,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                } catch (e) {
                    console.error("QRコードの生成に失敗しました:", e);
                    qrcodeDisplayEl.textContent = "QRコードの生成に失敗しました。";
                }
                
                qrCodeModal.classList.remove('hidden');
            }

            function openQrResultModal(itemId) {
                const item = managedItems.find(i => i.itemId === itemId);
                document.getElementById('qr-result-item-name').textContent = `${item.name} (${item.itemId})`;
                const contentEl = document.getElementById('qr-result-content');
                contentEl.innerHTML = '';

                // 貸出ボタン
                if(item.availableQuantity > 0) {
                    const lendBtn = document.createElement('button');
                    lendBtn.className = "w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-md transition-colors";
                    lendBtn.textContent = `貸出する (在庫: ${item.availableQuantity})`;
                    lendBtn.onclick = () => {
                        qrResultModal.classList.add('hidden');
                        openLendingModal(itemId);
                    };
                    contentEl.appendChild(lendBtn);
                }

                // 返却リスト
                const activeRecords = rentalRecords.filter(r => r.itemId === item.itemId && r.returnDate === null);
                if (activeRecords.length > 0) {
                    const returnSection = document.createElement('div');
                    returnSection.innerHTML = `<h3 class="text-lg font-semibold mt-4 pt-4 border-t">貸出中の記録</h3>`;
                    const list = document.createElement('div');
                    list.className = 'space-y-2 mt-2';
                    activeRecords.forEach(record => {
                        const recordEl = document.createElement('div');
                        recordEl.className = 'flex justify-between items-center text-sm p-2 bg-gray-50 rounded-md';
                        recordEl.innerHTML = `<div><p><strong>${escapeHTML(record.borrower)}</strong> (${record.quantity}個)</p><p class="text-gray-600">返却予定: ${record.dueDate}</p></div>`;
                        const returnBtn = document.createElement('button');
                        returnBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 text-xs rounded-md transition-colors';
                        returnBtn.textContent = '返却';
                        returnBtn.onclick = () => {
                            qrResultModal.classList.add('hidden');
                            openReturnModal(record.recordId);
                        };
                        recordEl.appendChild(returnBtn);
                        list.appendChild(recordEl);
                    });
                    returnSection.appendChild(list);
                    contentEl.appendChild(returnSection);
                }
                
                if (contentEl.innerHTML === '') {
                    contentEl.innerHTML = '<p class="text-gray-500 text-center">現在、この物品に関する操作はありません。</p>';
                }

                qrResultModal.classList.remove('hidden');
            }
            
            // --- ユーティリティ ---
            searchBoxEl.addEventListener('input', renderList);
            setupModal(addItemModal, openAddItemModalBtn, closeAddItemModalBtn);
            setupModal(lendingModal, null, closeLendingModalBtn);
            setupModal(returnModal, null, closeReturnModalBtn);
            setupModal(deleteConfirmModal, null, cancelDeleteBtn);
            setupModal(qrCodeModal, null, closeQrCodeModalBtn); // 新規
            setupModal(qrReaderModal, null, closeQrReaderBtn, stopQrScanner);
            setupModal(qrResultModal, null, closeQrResultModalBtn);
            
            newItemNameInput.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                const itemName = newItemNameInput.value.trim();
                if (itemName.length < 2) { newItemCategoryInput.value = ''; return; }
                newItemCategoryInput.value = '分類中...';
                categoryLoader.classList.remove('hidden');
                debounceTimer = setTimeout(() => getCategorySuggestion(itemName), 800);
            });

            async function getCategorySuggestion(itemName) {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const systemPrompt = "提示された物品名に対して、最も適切と思われるカテゴリを日本語の単語一つで答えてください。例：電子機器, 備品, 家具, 書籍, 音響機器。余計な説明は不要です。";
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `物品名: "${itemName}"` }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                        })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const result = await response.json();
                    newItemCategoryInput.value = result.candidates?.[0]?.content?.parts?.[0]?.text.trim().replace(/[\n."「」]/g, '') || '';
                } catch (error) {
                    console.error('カテゴリの取得に失敗しました:', error);
                    newItemCategoryInput.value = '';
                } finally {
                    categoryLoader.classList.add('hidden');
                }
            }

            function setupModal(modal, openBtn, closeBtn, closeCallback) {
                if (openBtn) openBtn.addEventListener('click', () => modal.classList.remove('hidden'));
                if (closeBtn) closeBtn.addEventListener('click', () => {
                    modal.classList.add('hidden');
                    if (closeCallback) closeCallback();
                });
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                        if (closeCallback) closeCallback();
                    }
                });
            }

            function escapeHTML(str) {
                const p = document.createElement('p');
                p.textContent = str;
                return p.innerHTML;
            }

            function showToast(message, isError = true) {
                const toast = document.getElementById('toast-notification');
                const toastMessage = document.getElementById('toast-message');
                toastMessage.textContent = message;
                toast.classList.remove('bg-red-500', 'bg-green-600', 'hidden', 'opacity-0');
                toast.classList.add(isError ? 'bg-red-500' : 'bg-green-600');
                setTimeout(() => { toast.classList.remove('opacity-0'); }, 10);
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                    setTimeout(() => toast.classList.add('hidden'), 300);
                }, 3000);
            }

            // 初期表示
            renderList();
        });
    </script>

</body>
</html>

